<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pemantau Gempa Indonesia | BMKG</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        :root {
            --primary: #3498db;
            --danger: #e74c3c;
            --warning: #f1c40f;
            --success: #2ecc71;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, sans-serif;
        }

        body {
            background: #f8f9fa;
        }

        header {
            background: var(--primary);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            max-width: 1400px;
            margin: 0 auto;
        }

        #map {
            flex: 1;
            min-height: 400px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            background: white;
        }

        .sidebar {
            width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 1rem;
            overflow-y: auto;
        }

        .earthquake-card {
            padding: 1rem;
            margin-bottom: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
            transition: transform 0.2s;
            cursor: pointer;
        }

        .earthquake-card:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .magnitude-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            margin-right: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
                padding: 0.5rem;
            }

            #map {
                height: 60vh;
                width: 100%;
            }

            .sidebar {
                width: 100%;
                height: 40vh;
            }

            header h1 {
                font-size: 1.25rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Pemantau Gempa Indonesia</h1>
        <p>Data Real-time dari BMKG | Update Otomatis Setiap 5 Menit</p>
    </header>

    <div class="container">
        <div id="map"></div>
        <div class="sidebar" id="sidebar"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Inisialisasi Peta dengan Error Handling
        let map;
        try {
            map = L.map('map', {
                zoomControl: false,
                preferCanvas: true
            }).setView([-2.5489, 118.0149], 5);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            L.control.zoom({ position: 'bottomright' }).addTo(map);
        } catch (error) {
            showError('Gagal memuat peta!');
            console.error('Map Error:', error);
        }

        // Fungsi Utama
        async function initApp() {
            try {
                const data = await fetchData();
                if (!data || !data.Infogempa?.gempa) {
                    showError('Data gempa tidak ditemukan');
                    return;
                }
                
                renderData(data.Infogempa.gempa);
                setupAutoRefresh();
            } catch (error) {
                showError('Gagal memuat data gempa');
                console.error('Init Error:', error);
            }
        }

        // Fetch Data dengan Timeout
        async function fetchData() {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 10000);
                
                const response = await fetch('https://data.bmkg.go.id/DataMKG/TEWS/gempaterkini.json', {
                    signal: controller.signal
                });
                
                clearTimeout(timeout);
                
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                return await response.json();
            } catch (error) {
                console.error('Fetch Error:', error);
                throw error;
            }
        }

        // Render Data ke Peta dan Sidebar
        function renderData(earthquakes) {
            // Clear existing data
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) map.removeLayer(layer);
            });
            document.getElementById('sidebar').innerHTML = '';

            earthquakes.forEach(gempa => {
                try {
                    const coords = parseCoordinates(gempa.Lintang, gempa.Bujur);
                    if (!coords) return;

                    // Add Map Marker
                    const marker = L.marker([coords.lat, coords.lng]).addTo(map);
                    marker.bindPopup(createPopupContent(gempa));

                    // Add Sidebar Card
                    const card = createEarthquakeCard(gempa, coords);
                    card.addEventListener('click', () => {
                        map.setView([coords.lat, coords.lng], 7);
                        marker.openPopup();
                    });
                    document.getElementById('sidebar').appendChild(card);
                } catch (error) {
                    console.error('Render Error:', error);
                }
            });

            // Auto-zoom to all markers
            if (earthquakes.length > 0) {
                const bounds = L.latLngBounds(earthquakes.map(g => {
                    const c = parseCoordinates(g.Lintang, g.Bujur);
                    return c ? [c.lat, c.lng] : null;
                }).filter(c => c));
                map.fitBounds(bounds.pad(0.1));
            }
        }

        // Helper Functions
        function parseCoordinates(latStr, lngStr) {
            try {
                const parse = (str, positiveDirections) => {
                    const [value, direction] = str.split(' ');
                    return positiveDirections.includes(direction) ? 
                        parseFloat(value) : -parseFloat(value);
                };

                return {
                    lat: -parse(latStr, ['LS']),
                    lng: parse(lngStr, ['BT'])
                };
            } catch (error) {
                console.error('Coordinate Error:', error);
                return null;
            }
        }

        function getMagnitudeColor(mag) {
            if (mag >= 6) return 'var(--danger)';
            if (mag >= 5) return 'var(--warning)';
            return 'var(--success)';
        }

        function createPopupContent(gempa) {
            return `
                <div style="min-width: 200px">
                    <h4 style="margin: 0 0 0.5rem">${gempa.Wilayah}</h4>
                    <p><b>Waktu:</b> ${gempa.Tanggal} ${gempa.Jam}</p>
                    <p><b>Magnitudo:</b> ${gempa.Magnitude}</p>
                    <p><b>Kedalaman:</b> ${gempa.Kedalaman}</p>
                </div>
            `;
        }

        function createEarthquakeCard(gempa, coords) {
            const card = document.createElement('div');
            card.className = 'earthquake-card';
            card.innerHTML = `
                <div style="display: flex; align-items: center">
                    <div class="magnitude-badge" style="background: ${getMagnitudeColor(gempa.Magnitude)}">
                        ${gempa.Magnitude}
                    </div>
                    <div>
                        <h3 style="margin-bottom: 0.25rem">${gempa.Wilayah}</h3>
                        <p style="font-size: 0.9em; color: #666">${gempa.Tanggal} ${gempa.Jam}</p>
                    </div>
                </div>
                <div style="margin-top: 0.5rem; font-size: 0.9em">
                    <p style="color: #666">Kedalaman: ${gempa.Kedalaman}</p>
                    <p style="color: #666">Koordinat: ${coords.lat.toFixed(2)}, ${coords.lng.toFixed(2)}</p>
                </div>
            `;
            return card;
        }

        function showError(message) {
            const el = document.createElement('div');
            el.style = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: var(--danger);
                color: white;
                padding: 12px 24px;
                border-radius: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                z-index: 1000;
            `;
            el.textContent = message;
            document.body.appendChild(el);
            
            setTimeout(() => el.remove(), 5000);
        }

        function setupAutoRefresh() {
            setInterval(async () => {
                try {
                    const data = await fetchData();
                    renderData(data.Infogempa.gempa);
                } catch (error) {
                    console.error('Auto Refresh Error:', error);
                }
            }, 300000);
        }

        // Event Listeners
        window.addEventListener('resize', () => {
            if (map) setTimeout(() => map.invalidateSize(), 100);
        });

        // Start App
        initApp();
    </script>
</body>
</html>